<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRace Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-item { text-align: center; }
        .lap-table { width: 100%; border-collapse: collapse; }
        .lap-table th, .lap-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .lap-table th { background-color: #f8f9fa; }
        .pb-badge { background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.online { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-card { background: #e9ecef; padding: 15px; border-radius: 6px; text-align: center; }
        h1, h2 { color: #333; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .refresh-btn:hover { background: #0056b3; }
        .auto-refresh { display: flex; align-items: center; gap: 10px; }
        .switch { position: relative; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ SmartRace Live Dashboard</h1>
        
        <div id="status" class="status">Verbindung wird hergestellt...</div>
        
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <button class="refresh-btn" onclick="loadData()">üîÑ Aktualisieren</button>
            <div class="auto-refresh">
                <span>Auto-Refresh:</span>
                <label class="switch">
                    <input type="checkbox" id="autoRefreshToggle" checked>
                    <span class="slider"></span>
                </label>
                <span id="autoRefreshStatus">AN</span>
            </div>
        </div>
        
        <div class="card">
            <h2>üìà System Informationen</h2>
            <div id="system-info" class="info-grid">
                <div class="info-card">
                    <strong>Gesamt Runden</strong><br>
                    <span id="total-laps">-</span>
                </div>
                <div class="info-card">
                    <strong>Unique Fahrer</strong><br>
                    <span id="unique-drivers">-</span>
                </div>
                <div class="info-card">
                    <strong>Datenbank Gr√∂√üe</strong><br>
                    <span id="database-size">-</span>
                </div>
                <div class="info-card">
                    <strong>Letzte Aktualisierung</strong><br>
                    <span id="last-update">-</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Fahrerstatistiken</h2>
            <div id="driver-stats" class="stats-grid">
                <p>Lade Statistiken...</p>
            </div>
        </div>
        
        <div class="card">
            <h2>üèÉ‚Äç‚ôÇÔ∏è Aktuelle Runden</h2>
            <div id="recent-laps">
                <p>Lade Rundendaten...</p>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;

        function formatTime(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = ((milliseconds % 60000) / 1000).toFixed(3);
            return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function loadData() {
            fetch('/api/live-data')
                .then(response => response.json())
                .then(data => {
                    updateStatus('online', `Verbunden - Letzte Aktualisierung: ${data.last_update}`);
                    updateSystemInfo(data.database_info, data.last_update);
                    updateDriverStats(data.driver_stats);
                    updateRecentLaps(data.recent_laps);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Daten:', error);
                    updateStatus('error', 'Fehler beim Laden der Daten - √úberpr√ºfe die Verbindung');
                });
        }

        function updateStatus(type, message) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
        }

        function updateSystemInfo(dbInfo, lastUpdate) {
            document.getElementById('total-laps').textContent = dbInfo.total_laps || 0;
            document.getElementById('unique-drivers').textContent = dbInfo.unique_drivers || 0;
            document.getElementById('database-size').textContent = formatBytes(dbInfo.database_size || 0);
            document.getElementById('last-update').textContent = lastUpdate;
        }

        function updateDriverStats(stats) {
            const container = document.getElementById('driver-stats');
            if (stats.length === 0) {
                container.innerHTML = '<p>Noch keine Statistiken verf√ºgbar</p>';
                return;
            }

            container.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <h3>${stat.driver_name}</h3>
                    <p><strong>Runden:</strong> ${stat.total_laps}</p>
                    <p><strong>Bestzeit:</strong> ${formatTime(stat.best_time)}</p>
                    <p><strong>Durchschnitt:</strong> ${formatTime(Math.round(stat.avg_time))}</p>
                </div>
            `).join('');
        }

        function updateRecentLaps(laps) {
            const container = document.getElementById('recent-laps');
            if (laps.length === 0) {
                container.innerHTML = '<p>Noch keine Rundendaten verf√ºgbar</p>';
                return;
            }

            container.innerHTML = `
                <table class="lap-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Fahrer</th>
                            <th>Runde</th>
                            <th>Rundenzeit</th>
                            <th>S1</th>
                            <th>S2</th>
                            <th>S3</th>
                            <th>PB</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${laps.map(lap => `
                            <tr>
                                <td>${lap.datetime}</td>
                                <td>${lap.driver_name}</td>
                                <td>${lap.lap}</td>
                                <td><strong>${lap.laptime}</strong></td>
                                <td>${lap.sector_1} ${lap.sector_1_pb ? '<span class="pb-badge">PB</span>' : ''}</td>
                                <td>${lap.sector_2} ${lap.sector_2_pb ? '<span class="pb-badge">PB</span>' : ''}</td>
                                <td>${lap.sector_3} ${lap.sector_3_pb ? '<span class="pb-badge">PB</span>' : ''}</td>
                                <td>${lap.lap_pb ? '<span class="pb-badge">LAP PB</span>' : ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            const status = document.getElementById('autoRefreshStatus');
            
            autoRefreshEnabled = toggle.checked;
            status.textContent = autoRefreshEnabled ? 'AN' : 'AUS';
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(loadData, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Event Listeners
        document.getElementById('autoRefreshToggle').addEventListener('change', toggleAutoRefresh);

        // Initiales Laden der Daten
        loadData();

        // Starte Auto-Refresh
        startAutoRefresh();
    </script>
</body>
</html>
